{% extends "base.html" %}
{% block title %}{{ photo.title._content if photo.title and photo.title._content else 'Untitled' }} | Old Style Flickr{% endblock %}

{% block nav_extra %}
<a href="javascript:history.back();">Back to stream</a>
{% endblock %}
{% block content %}
<div class="photo-image" style="position:relative; width:100%; max-width:800px; aspect-ratio: 4/3; margin:auto; background: repeating-conic-gradient(#eee 0% 25%, #ddd 0% 50%) 50% / 32px 32px; display:flex; align-items:center; justify-content:center;">
  <img id="progressive-photo" src="{{ image_urls[0] if image_urls else image_url }}" alt="{{ photo.title._content or photo.title }}" style="width:100%; height:100%; object-fit:contain; border-radius:8px; box-shadow: 0 2px 12px #0002; image-rendering: pixelated; transition: image-rendering 0.6s; background:#fafafd;">
</div>
<script>
  // Progressive image loading
  const imageUrls = {{ image_urls| tojson | safe }};
  const img = document.getElementById('progressive-photo');
  if (imageUrls.length > 1) {
    let current = 0;
    function loadNext() {
      current++;
      if (current >= imageUrls.length) {
        img.style.filter = 'none'; // Final image, remove blur
        return;
      }
      const nextImg = new window.Image();
      nextImg.src = imageUrls[current];
      nextImg.onload = function () {
        img.src = nextImg.src;
        // Retro: pixelate until the last image, then smooth
        if (current === imageUrls.length - 1) {
          img.style.imageRendering = 'auto';
          img.style.filter = 'none';
        } else {
          img.style.imageRendering = 'pixelated';
          img.style.filter = 'none';
        }
        setTimeout(loadNext, 300); // Wait a bit, then load the next quality
      };
    }
    img.onload = function () {
      // Only start progressive load if the initial image is loaded
      setTimeout(loadNext, 400);
    }
  } else {
    img.style.filter = 'none';
  }
</script>
<div class="photo-detail-page">
  <h2>{{ photo.title._content if photo.title and photo.title._content else 'Untitled' }}</h2>
  <div class="photo-meta">
    <strong>By:</strong> {{ photo.owner.realname or photo.owner.username if photo.owner else 'Unknown' }}<br>
    <strong>Date uploaded:</strong> {% if photo.dates and photo.dates.posted %}{{ photo.dates.posted | int | datetimeformat }}{% else %}N/A{% endif %}<br>
    <strong>Date taken:</strong> {% if photo.dates and photo.dates.taken %}{{ photo.dates.taken | datetimeformat }}{% else %}N/A{% endif %}<br>
    <strong>Views:</strong> {{ photo.views or 'N/A' }}<br>
    <strong>Comments:</strong> {% if photo.comments and photo.comments._content is defined %}{{ photo.comments._content }}{% else %}0{% endif %}<br>
    <strong>Tags:</strong> {% if photo.tags %}{{ photo.tags|join(', ') }}{% else %}None{% endif %}<br>
  </div>
  {% if photo.description and photo.description._content %}
  <div class="photo-desc" style="margin-top:1em;">{{ photo.description._content }}</div>
  {% endif %}
</div>
{% endblock %}